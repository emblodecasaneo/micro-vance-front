import{_ as Z,c as n,b as e,d as F,w as U,g as $,t as l,x as c,y as x,z as f,F as tt,l as et,n as E,v as rt,N as ot,L as st,B as b,r as u,o as at,O as lt,a as h,M as nt,m as i}from"./index-CHW42hPp.js";const it={name:"LoanFormView",setup(){const w=st(),r=nt(),{showToast:_}=ot(),t=w.params.id,g=b(()=>!!t),d=u({client_id:"",amount:0,interest_rate:10,term_months:12,start_date:new Date().toISOString().slice(0,10),collateral_description:"",collateral_value:0,collateral_photo_path:""}),m=u([]),s=u(!1),C=u(!1),D=u({}),S=u(!1),y=u(""),k=u(!1),L=u([]),p=u(null),I=b(()=>{const o=d.value.amount||0,a=(d.value.interest_rate||0)/100,v=d.value.term_months||0;return o*a*(v/12)}),A=b(()=>(d.value.amount||0)+I.value),N=b(()=>{const o=d.value.term_months||1;return A.value/o}),P=b(()=>{if(!d.value.start_date)return"";const o=new Date(d.value.start_date);return o.setMonth(o.getMonth()+(d.value.term_months||0)),o.toISOString().slice(0,10)}),B=b(()=>new Date().toISOString().slice(0,10)),V=async()=>{if(!g.value){if(w.query.client_id)try{const o=await h.getClient(w.query.client_id);if(o.data&&o.data.status==="success"){const a=o.data.data;p.value=a,d.value.client_id=a.id,y.value=`${a.first_name} ${a.last_name}`.trim()}}catch(o){console.error("Erreur lors du chargement du client:",o)}return}s.value=!0;try{const a=(await h.getLoan(t)).data.data.loan;a.start_date=a.start_date?new Date(a.start_date).toISOString().slice(0,10):"",Object.keys(d.value).forEach(v=>{a[v]!==void 0&&(d.value[v]=a[v])}),a.client&&a.client_id&&(p.value=a.client,y.value=`${a.client.first_name} ${a.client.last_name}`.trim())}catch(o){console.error("Erreur lors du chargement du prêt:",o),_("Erreur lors du chargement du prêt.","error"),r.push("/loans")}finally{s.value=!1}},R=async()=>{try{const o=await h.getClients({per_page:100});console.log("Réponse API clients:",o.data),o.data.status==="success"?(m.value=o.data.data,console.log("Clients chargés:",m.value.length)):(console.error("Format de réponse API inattendu:",o.data),_("Format de réponse API inattendu.","error"))}catch(o){console.error("Erreur lors du chargement des clients:",o),_("Erreur lors du chargement des clients.","error")}},T=()=>{S.value=!0},j=async()=>{C.value=!0,D.value={};try{let o;g.value?o=await h.updateLoan(t,d.value):o=await h.createLoan(d.value),_(`Prêt ${g.value?"mis à jour":"créé"} avec succès.`,"success");const a=g.value?t:o.data.data.id;r.push(`/loans/${a}`)}catch(o){console.error("Erreur lors de l'enregistrement du prêt:",o),_("Erreur lors de l'enregistrement du prêt.","error"),o.response&&o.response.data&&o.response.data.errors&&(D.value=o.response.data.errors)}finally{C.value=!1}},z=()=>{r.push("/loans")},O=o=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XAF"}).format(o),q=o=>{if(!o)return"N/A";const a=new Date(o);return new Intl.DateTimeFormat("fr-FR").format(a)},H=()=>{if(!m.value||m.value.length===0||!y.value.trim()){L.value=[];return}const o=y.value.toLowerCase();L.value=m.value.filter(a=>{const v=a.first_name||"",J=a.last_name||"",K=`${v} ${J}`.toLowerCase(),Q=(a.phone_number||"").toLowerCase(),W=(a.email||"").toLowerCase(),Y=(a.id_card_number||"").toLowerCase();return K.includes(o)||Q.includes(o)||W.includes(o)||Y.includes(o)})},X=o=>{p.value=o,d.value.client_id=o.id,y.value=`${o.first_name} ${o.last_name}`.trim(),k.value=!1},G=()=>{p.value=null,d.value.client_id="",y.value=""},M=o=>{k.value&&!o.target.closest("#client-search")&&(k.value=!1)};return at(()=>{R(),V(),document.addEventListener("click",M)}),lt(()=>{document.removeEventListener("click",M)}),{loanData:d,clients:m,loading:s,saving:C,errors:D,isEditMode:g,showSimulation:S,calculatedInterest:I,calculatedTotalAmount:A,calculatedMonthlyPayment:N,estimatedEndDate:P,today:B,loadLoan:V,simulateLoan:T,saveLoan:j,cancel:z,formatCurrency:O,formatDate:q,clientSearch:y,showClientDropdown:k,filteredClients:L,selectedClient:p,searchClients:H,selectClient:X,clearSelectedClient:G,handleClickOutside:M}}},dt={class:"flex justify-between items-center mb-4"},ct={class:"flex items-center"},ut={class:"text-sm font-medium text-gray-800"},mt={key:0,class:"flex justify-center py-6"},xt={key:1,class:"bg-white shadow-sm rounded-lg p-4 border border-gray-200"},ft={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},yt={class:"space-y-3"},vt={class:"relative"},_t=["disabled"],gt={key:0,class:"absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg"},bt={class:"max-h-60 overflow-auto"},pt=["onClick"],ht={class:"flex items-center"},wt={class:"h-8 w-8 rounded-full bg-secondary text-white flex items-center justify-center text-sm font-medium"},Ct={class:"ml-3"},kt={class:"text-sm font-medium text-gray-900"},Dt={class:"text-xs text-gray-500"},Lt={key:1,class:"absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg"},Mt={class:"px-4 py-2 text-sm text-gray-500"},Et={key:0,class:"mt-3 p-3 bg-gray-50 rounded-md"},St={class:"flex items-center"},It={class:"h-10 w-10 rounded-full bg-secondary text-white flex items-center justify-center text-sm font-medium"},At={class:"ml-3 flex-grow"},Vt={class:"text-sm font-medium text-gray-900"},Ft={class:"text-xs text-gray-500"},Ut={key:1,class:"text-red-500 text-xs mt-1"},Nt={key:0,class:"text-red-500 text-xs mt-1"},Pt={key:0,class:"text-red-500 text-xs mt-1"},Bt={key:0,class:"text-red-500 text-xs mt-1"},Rt={class:"space-y-3"},Tt=["min"],jt={key:0,class:"text-red-500 text-xs mt-1"},zt={key:0,class:"text-red-500 text-xs mt-1"},Ot={key:0,class:"text-red-500 text-xs mt-1"},qt={key:0,class:"text-red-500 text-xs mt-1"},Ht={key:0,class:"mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200 mt-4"},Xt={class:"grid grid-cols-2 md:grid-cols-3 gap-3"},Gt={class:"text-xs font-medium text-gray-700"},Jt={class:"text-xs font-medium text-gray-700"},Kt={class:"text-xs font-medium text-gray-700"},Qt={class:"text-xs font-medium text-gray-700"},Wt={class:"text-xs font-medium text-gray-700"},Yt={class:"text-xs font-medium text-gray-700"},Zt={class:"flex justify-between mt-4"},$t={class:"flex space-x-2"},te=["disabled"],ee={key:0},re={key:1};function oe(w,r,_,t,g,d){const m=$("router-link");return i(),n("div",null,[e("div",dt,[e("div",ct,[F(m,{to:"/loans",class:"text-primary hover:text-primary-dark flex items-center mr-3"},{default:U(()=>r[14]||(r[14]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor"},[e("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1),e("span",{class:"text-xs"},"Retour à la liste",-1)])),_:1}),e("h1",ut,l(t.isEditMode?"Modifier le prêt":"Nouveau prêt"),1)])]),t.loading?(i(),n("div",mt,r[15]||(r[15]=[e("svg",{class:"animate-spin h-5 w-5 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)]))):(i(),n("div",xt,[e("form",{onSubmit:r[13]||(r[13]=rt((...s)=>t.saveLoan&&t.saveLoan(...s),["prevent"]))},[e("div",ft,[e("div",yt,[e("div",null,[r[19]||(r[19]=e("label",{for:"client_id",class:"block text-xs font-medium text-gray-700 mb-1"},"Client *",-1)),e("div",vt,[x(e("input",{type:"text",id:"client-search","onUpdate:modelValue":r[0]||(r[0]=s=>t.clientSearch=s),onInput:r[1]||(r[1]=(...s)=>t.searchClients&&t.searchClients(...s)),onFocus:r[2]||(r[2]=s=>t.showClientDropdown=!0),placeholder:"Rechercher un client par nom...",class:"block w-full text-xs focus:outline-none rounded-md h-[34px] px-3 border border-gray-300",disabled:t.isEditMode},null,40,_t),[[f,t.clientSearch]]),t.showClientDropdown&&t.filteredClients.length>0&&!t.isEditMode?(i(),n("div",gt,[e("ul",bt,[(i(!0),n(tt,null,et(t.filteredClients,s=>(i(),n("li",{key:s.id,onClick:C=>t.selectClient(s),class:"px-4 py-2 cursor-pointer hover:bg-gray-100"},[e("div",ht,[e("div",wt,l(s.first_name.charAt(0).toUpperCase()+s.last_name.charAt(0).toUpperCase()),1),e("div",Ct,[e("div",kt,l(s.first_name)+" "+l(s.last_name),1),e("div",Dt,l(s.id_card_number||"Pas d'ID")+" • "+l(s.phone_number||"Pas de téléphone"),1)])])],8,pt))),128))])])):t.showClientDropdown&&t.clientSearch&&t.filteredClients.length===0&&!t.isEditMode?(i(),n("div",Lt,[e("div",Mt,[r[17]||(r[17]=E(" Aucun client trouvé. ")),F(m,{to:"/clients/new",class:"text-primary hover:underline"},{default:U(()=>r[16]||(r[16]=[E("Créer un nouveau client")])),_:1})])])):c("",!0)]),t.selectedClient?(i(),n("div",Et,[e("div",St,[e("div",It,l(t.selectedClient.first_name.charAt(0).toUpperCase()+t.selectedClient.last_name.charAt(0).toUpperCase()),1),e("div",At,[e("div",Vt,l(t.selectedClient.first_name)+" "+l(t.selectedClient.last_name),1),e("div",Ft,l(t.selectedClient.id_card_number||"Pas d'ID")+" • "+l(t.selectedClient.phone_number||"Pas de téléphone"),1)]),t.isEditMode?c("",!0):(i(),n("button",{key:0,type:"button",onClick:r[3]||(r[3]=(...s)=>t.clearSelectedClient&&t.clearSelectedClient(...s)),class:"text-gray-400 hover:text-gray-500"},r[18]||(r[18]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])))])])):c("",!0),t.errors.client_id?(i(),n("div",Ut,l(t.errors.client_id),1)):c("",!0)]),e("div",null,[r[20]||(r[20]=e("label",{for:"amount",class:"block text-xs font-medium text-gray-700 mb-1"},"Montant (XAF) *",-1)),x(e("input",{id:"amount",type:"number","onUpdate:modelValue":r[4]||(r[4]=s=>t.loanData.amount=s),required:"",min:"1000",class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,512),[[f,t.loanData.amount,void 0,{number:!0}]]),t.errors.amount?(i(),n("div",Nt,l(t.errors.amount),1)):c("",!0)]),e("div",null,[r[21]||(r[21]=e("label",{for:"interest_rate",class:"block text-xs font-medium text-gray-700 mb-1"},"Taux d'intérêt (%) *",-1)),x(e("input",{id:"interest_rate",type:"number","onUpdate:modelValue":r[5]||(r[5]=s=>t.loanData.interest_rate=s),required:"",min:"0",max:"100",step:"0.01",class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,512),[[f,t.loanData.interest_rate,void 0,{number:!0}]]),t.errors.interest_rate?(i(),n("div",Pt,l(t.errors.interest_rate),1)):c("",!0)]),e("div",null,[r[22]||(r[22]=e("label",{for:"term_months",class:"block text-xs font-medium text-gray-700 mb-1"},"Durée (mois) *",-1)),x(e("input",{id:"term_months",type:"number","onUpdate:modelValue":r[6]||(r[6]=s=>t.loanData.term_months=s),required:"",min:"1",max:"60",class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,512),[[f,t.loanData.term_months,void 0,{number:!0}]]),t.errors.term_months?(i(),n("div",Bt,l(t.errors.term_months),1)):c("",!0)])]),e("div",Rt,[e("div",null,[r[23]||(r[23]=e("label",{for:"start_date",class:"block text-xs font-medium text-gray-700 mb-1"},"Date de début *",-1)),x(e("input",{id:"start_date",type:"date","onUpdate:modelValue":r[7]||(r[7]=s=>t.loanData.start_date=s),required:"",min:t.today,class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,8,Tt),[[f,t.loanData.start_date]]),t.errors.start_date?(i(),n("div",jt,l(t.errors.start_date),1)):c("",!0)]),e("div",null,[r[24]||(r[24]=e("label",{for:"collateral_description",class:"block text-xs font-medium text-gray-700 mb-1"},"Description de la garantie",-1)),x(e("textarea",{id:"collateral_description","onUpdate:modelValue":r[8]||(r[8]=s=>t.loanData.collateral_description=s),class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary",rows:"2"},null,512),[[f,t.loanData.collateral_description]]),t.errors.collateral_description?(i(),n("div",zt,l(t.errors.collateral_description),1)):c("",!0)]),e("div",null,[r[25]||(r[25]=e("label",{for:"collateral_value",class:"block text-xs font-medium text-gray-700 mb-1"},"Valeur de la garantie (XAF)",-1)),x(e("input",{id:"collateral_value",type:"number","onUpdate:modelValue":r[9]||(r[9]=s=>t.loanData.collateral_value=s),min:"0",class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,512),[[f,t.loanData.collateral_value,void 0,{number:!0}]]),t.errors.collateral_value?(i(),n("div",Ot,l(t.errors.collateral_value),1)):c("",!0)]),e("div",null,[r[26]||(r[26]=e("label",{for:"collateral_photo_path",class:"block text-xs font-medium text-gray-700 mb-1"},"Photo de la garantie (URL)",-1)),x(e("input",{id:"collateral_photo_path",type:"text","onUpdate:modelValue":r[10]||(r[10]=s=>t.loanData.collateral_photo_path=s),class:"block w-full text-xs text-gray-600 py-1.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"},null,512),[[f,t.loanData.collateral_photo_path]]),t.errors.collateral_photo_path?(i(),n("div",qt,l(t.errors.collateral_photo_path),1)):c("",!0)])])]),t.showSimulation?(i(),n("div",Ht,[r[33]||(r[33]=e("h3",{class:"text-xs font-semibold text-gray-800 mb-2"},"Résumé du prêt",-1)),e("div",Xt,[e("div",null,[r[27]||(r[27]=e("p",{class:"text-xs text-gray-500"},"Montant du prêt",-1)),e("p",Gt,l(t.formatCurrency(t.loanData.amount)),1)]),e("div",null,[r[28]||(r[28]=e("p",{class:"text-xs text-gray-500"},"Intérêts totaux",-1)),e("p",Jt,l(t.formatCurrency(t.calculatedInterest)),1)]),e("div",null,[r[29]||(r[29]=e("p",{class:"text-xs text-gray-500"},"Montant total",-1)),e("p",Kt,l(t.formatCurrency(t.calculatedTotalAmount)),1)]),e("div",null,[r[30]||(r[30]=e("p",{class:"text-xs text-gray-500"},"Mensualité",-1)),e("p",Qt,l(t.formatCurrency(t.calculatedMonthlyPayment)),1)]),e("div",null,[r[31]||(r[31]=e("p",{class:"text-xs text-gray-500"},"Date de début",-1)),e("p",Wt,l(t.formatDate(t.loanData.start_date)),1)]),e("div",null,[r[32]||(r[32]=e("p",{class:"text-xs text-gray-500"},"Date de fin estimée",-1)),e("p",Yt,l(t.formatDate(t.estimatedEndDate)),1)])])])):c("",!0),e("div",Zt,[e("button",{type:"button",onClick:r[11]||(r[11]=(...s)=>t.simulateLoan&&t.simulateLoan(...s)),class:"btn btn-secondary"}," Simuler le prêt "),e("div",$t,[e("button",{type:"button",onClick:r[12]||(r[12]=(...s)=>t.cancel&&t.cancel(...s)),class:"btn btn-secondary"}," Annuler "),e("button",{type:"submit",class:"btn btn-primary",disabled:t.saving},[t.saving?(i(),n("span",ee,r[34]||(r[34]=[e("svg",{class:"animate-spin -ml-1 mr-2 h-3 w-3 text-white inline-block",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),E(" Enregistrement... ")]))):(i(),n("span",re,"Enregistrer"))],8,te)])])],32)]))])}const ae=Z(it,[["render",oe],["__scopeId","data-v-76b51f55"]]);export{ae as default};
